{% extends "base.html" %}

{% block title %}Activities - {{ trip.name }} - HaleWay{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <div class="header-content">
            <div>
                <nav class="breadcrumb">
                    <a href="{% url 'trips:trip_detail' trip.pk %}">{{ trip.name }}</a>
                    <span>/</span>
                    <span>Activities</span>
                </nav>
                <h1>Activities for {{ trip.name }}</h1>
            </div>
            {% if can_create_activity %}
                <a href="{% url 'activities:activity_create' trip.pk %}" class="btn btn-primary">
                    + Add Activity
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Sorting Options -->
    <div class="sort-controls">
        <label>Sort by:</label>
        <div class="sort-buttons">
            <a href="?sort=priority" class="btn btn-sm {% if current_sort == 'priority' %}btn-primary{% else %}btn-outline{% endif %}">
                Priority
            </a>
            <a href="?sort=name" class="btn btn-sm {% if current_sort == 'name' %}btn-primary{% else %}btn-outline{% endif %}">
                Name
            </a>
            <a href="?sort=distance" class="btn btn-sm {% if current_sort == 'distance' %}btn-primary{% else %}btn-outline{% endif %}">
                Distance
            </a>
            <a href="?sort=cost" class="btn btn-sm {% if current_sort == 'cost' %}btn-primary{% else %}btn-outline{% endif %}">
                Cost
            </a>
            <a href="?sort=rating" class="btn btn-sm {% if current_sort == 'rating' %}btn-primary{% else %}btn-outline{% endif %}">
                Rating
            </a>
            <a href="?sort=favorites" class="btn btn-sm {% if current_sort == 'favorites' %}btn-primary{% else %}btn-outline{% endif %}">
                Favorites
            </a>
        </div>
    </div>

    {% if activities %}
        <div class="activities-list" id="activities-list">
            {% for activity in activities %}
                <div class="card activity-card" data-activity-id="{{ activity.id }}">
                    <div class="card-header">
                        <div class="activity-header-content">
                            {% if current_sort == 'priority' and can_edit %}
                                <span class="drag-handle" title="Drag to reorder">‚ò∞</span>
                            {% endif %}
                            <div>
                                <h3>{{ activity.name }}</h3>
                                {% if activity.is_favorite %}
                                    <span class="badge badge-favorite">‚≠ê Favorite</span>
                                {% endif %}
                            </div>
                        </div>
                        {% if activity.pre_trip_priority > 0 %}
                            <span class="badge badge-priority">Priority #{{ activity.pre_trip_priority }}</span>
                        {% endif %}
                    </div>
                    <div class="card-body">
                        {% if activity.description %}
                            <p class="description">{{ activity.description|truncatewords:20 }}</p>
                        {% endif %}

                        <div class="activity-info">
                            {% if activity.city %}
                                <div class="info-item">
                                    <strong>üìç</strong> {{ activity.city }}{% if activity.state %}, {{ activity.state }}{% endif %}
                                </div>
                            {% endif %}

                            {% if activity.distance_from_resort %}
                                <div class="info-item">
                                    <strong>üöó</strong> {{ activity.distance_from_resort }} mi from resort
                                </div>
                            {% endif %}

                            {% if activity.estimated_cost %}
                                <div class="info-item">
                                    <strong>üí∞</strong> ${{ activity.estimated_cost|floatformat:2 }} per person
                                </div>
                            {% endif %}

                            {% if activity.estimated_duration %}
                                <div class="info-item">
                                    <strong>‚è±Ô∏è</strong> {{ activity.get_duration_display }}
                                </div>
                            {% endif %}

                            {% if activity.post_trip_rating %}
                                <div class="info-item">
                                    <strong>‚≠ê</strong> {{ activity.post_trip_rating }}/5 stars
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="card-footer">
                        <a href="{% url 'activities:activity_detail' activity.pk %}" class="btn btn-sm btn-primary">
                            View Details
                        </a>
                        {% if can_edit %}
                            <a href="{% url 'activities:activity_edit' activity.pk %}" class="btn btn-sm btn-outline">
                                Edit
                            </a>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty-state">
            <h2>No Activities Yet</h2>
            <p>Start adding activities and attractions for your trip!</p>
            {% if can_create_activity %}
                <a href="{% url 'activities:activity_create' trip.pk %}" class="btn btn-primary btn-lg">
                    + Add First Activity
                </a>
            {% endif %}
        </div>
    {% endif %}
</div>

<style>
.page-header {
    margin-bottom: var(--spacing-xl);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--spacing-md);
}

.breadcrumb {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: var(--spacing-sm);
}

.breadcrumb a {
    color: var(--primary-color);
    text-decoration: none;
}

.breadcrumb a:hover {
    text-decoration: underline;
}

.sort-controls {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-lg);
    padding: var(--spacing-md);
    background-color: var(--gray-50);
    border-radius: var(--border-radius);
}

.sort-buttons {
    display: flex;
    gap: var(--spacing-sm);
    flex-wrap: wrap;
}

.activities-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
}

.activity-card {
    transition: transform var(--transition-fast);
}

.activity-card:hover {
    transform: translateY(-2px);
}

.activity-header-content {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
}

.drag-handle {
    cursor: move;
    font-size: 1.25rem;
    color: var(--text-secondary);
    user-select: none;
}

.drag-handle:hover {
    color: var(--primary-color);
}

.description {
    color: var(--text-secondary);
    margin-bottom: var(--spacing-md);
}

.activity-info {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
}

.info-item {
    font-size: 0.9375rem;
    color: var(--text-primary);
}

.badge-priority {
    background-color: var(--primary-color);
    color: white;
}

.badge-favorite {
    background-color: var(--warning-color);
    color: #000;
}

.empty-state {
    text-align: center;
    padding: var(--spacing-xxl);
}

@media (max-width: 768px) {
    .header-content {
        flex-direction: column;
        align-items: stretch;
    }

    .sort-controls {
        flex-direction: column;
        align-items: stretch;
    }

    .sort-buttons {
        flex-direction: column;
    }
}

/* Drag and drop styles */
.activity-card.dragging {
    opacity: 0.5;
}

.activity-card.drag-over {
    border-top: 3px solid var(--primary-color);
}
</style>

{% if current_sort == 'priority' and can_edit %}
<script>
// Drag and drop functionality for priority ordering
document.addEventListener('DOMContentLoaded', function() {
    const activitiesList = document.getElementById('activities-list');
    const activityCards = document.querySelectorAll('.activity-card');

    let draggedElement = null;

    activityCards.forEach(card => {
        const dragHandle = card.querySelector('.drag-handle');

        if (dragHandle) {
            // Make card draggable via handle
            dragHandle.addEventListener('mousedown', function() {
                card.setAttribute('draggable', 'true');
            });

            card.addEventListener('dragstart', function(e) {
                draggedElement = this;
                this.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            card.addEventListener('dragend', function(e) {
                this.classList.remove('dragging');
                this.setAttribute('draggable', 'false');

                // Remove all drag-over classes
                activityCards.forEach(c => c.classList.remove('drag-over'));

                // Update priorities after drag ends
                updatePriorities();
            });

            card.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';

                if (draggedElement !== this) {
                    this.classList.add('drag-over');
                }
            });

            card.addEventListener('dragleave', function(e) {
                this.classList.remove('drag-over');
            });

            card.addEventListener('drop', function(e) {
                e.preventDefault();

                if (draggedElement !== this) {
                    // Insert dragged element before or after this element
                    const allCards = [...activitiesList.querySelectorAll('.activity-card')];
                    const draggedIndex = allCards.indexOf(draggedElement);
                    const targetIndex = allCards.indexOf(this);

                    if (draggedIndex < targetIndex) {
                        this.parentNode.insertBefore(draggedElement, this.nextSibling);
                    } else {
                        this.parentNode.insertBefore(draggedElement, this);
                    }
                }

                this.classList.remove('drag-over');
            });
        }
    });

    function updatePriorities() {
        const cards = activitiesList.querySelectorAll('.activity-card');
        const updates = [];

        cards.forEach((card, index) => {
            const activityId = card.dataset.activityId;
            const newPriority = index + 1;

            // Update priority via AJAX
            fetch('{% url "activities:update_priority" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: `activity_id=${activityId}&priority=${newPriority}`
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.error('Failed to update priority:', data.error);
                }
            })
            .catch(error => {
                console.error('Error updating priority:', error);
            });
        });
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endif %}

{% endblock %}
