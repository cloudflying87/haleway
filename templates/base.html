{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="HaleWay - Plan vacations and preserve memories with your ohana">
    <title>{% block title %}HaleWay{% endblock %}</title>

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'img/icons/favicon-16x16.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'img/icons/favicon-32x32.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'img/icons/apple-touch-icon.png' %}">

    <!-- PWA Manifest -->
    <link rel="manifest" href="{% static 'manifest.json' %}">
    <meta name="theme-color" content="#2E86AB">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="HaleWay">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="{% block og_url %}https://haleway.flyhomemnlab.com/{% endblock %}">
    <meta property="og:title" content="{% block og_title %}HaleWay - Family Trip Planner{% endblock %}">
    <meta property="og:description" content="{% block og_description %}HaleWay helps families plan vacations and preserve memories in one place. Organize activities, create itineraries, track budgets, and rate experiences.{% endblock %}">
    <meta property="og:image" content="{% block og_image %}{% static 'img/default-share.png' %}{% endblock %}">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="HaleWay">
    <meta property="og:locale" content="en_US">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="{% block twitter_url %}https://haleway.flyhomemnlab.com/{% endblock %}">
    <meta name="twitter:title" content="{% block twitter_title %}HaleWay - Family Trip Planner{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}HaleWay helps families plan vacations and preserve memories in one place. Organize activities, create itineraries, track budgets, and rate experiences.{% endblock %}">
    <meta name="twitter:image" content="{% block twitter_image %}{% static 'img/default-share.png' %}{% endblock %}">

    <!-- Base CSS -->
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/buttons.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/forms.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/cards.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/navbar.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/alerts.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/breadcrumbs.css' %}">
    <link rel="stylesheet" href="{% static 'css/components/modals.css' %}">

    <!-- Page-specific CSS -->
    {% block extra_css %}{% endblock %}
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar">
      <div class="container">
        <div class="navbar-brand">
          <a href="{% if user.is_authenticated %}{% url 'core:dashboard' %}{% else %}{% url 'core:home' %}{% endif %}" class="logo">
            <span class="logo-text">HaleWay</span>
          </a>
        </div>

        <div class="navbar-menu">
          {% if user.is_authenticated %}
            <a href="{% url 'core:dashboard' %}" class="nav-link">Dashboard</a>

            <!-- Trips Dropdown -->
            <div class="navbar-dropdown">
              <button class="nav-dropdown-toggle" onclick="toggleTripsMenu(event)">
                Trips ‚ñæ
              </button>
              <div class="nav-dropdown-menu" id="tripsMenu">
                <a href="{% url 'trips:trip_list' %}" class="dropdown-item">
                  All Trips
                </a>
                <a href="{% url 'trips:dream_trip_list' %}" class="dropdown-item">
                  Dream Trips
                </a>
                <a href="{% url 'trips:wishlist_list' %}" class="dropdown-item">
                  Resort Wishlist
                </a>
                <a href="{% url 'trips:resort_list' %}" class="dropdown-item">
                  All Resorts
                </a>
              </div>
            </div>

            {% if current_trip %}
              <!-- Current Trip Dropdown -->
              <div class="navbar-dropdown">
                <button class="nav-dropdown-toggle" onclick="toggleTripMenu(event)">
                  {{ current_trip.name|truncatechars:20 }} ‚ñæ
                </button>
                <div class="nav-dropdown-menu" id="tripMenu">
                  <div class="dropdown-header">Quick Links</div>
                  <a href="{% url 'packing:create_packing_list' current_trip.pk %}" class="dropdown-item">
                    üéí Packing List
                  </a>
                  <a href="{% url 'grocery:trip_grocery_lists' current_trip.pk %}" class="dropdown-item">
                    üõí Grocery Lists
                  </a>
                  <a href="{% url 'itinerary:calendar' current_trip.pk %}" class="dropdown-item">
                    üìÖ Itinerary
                  </a>
                  <a href="{% url 'activities:activity_list' current_trip.pk %}" class="dropdown-item">
                    üéØ Activities
                  </a>
                  <a href="{% url 'notes:note_list' current_trip.pk %}" class="dropdown-item">
                    üìù Notes
                  </a>
                  <div class="dropdown-divider"></div>
                  <a href="{% url 'trips:trip_detail' current_trip.pk %}" class="dropdown-item">
                    View Trip Details
                  </a>
                  <a href="#" onclick="openTripSwitcher(event)" class="dropdown-item">
                    Switch Trip...
                  </a>
                </div>
              </div>
            {% else %}
              <a href="{% url 'trips:trip_list' %}" class="nav-link">My Trips</a>
            {% endif %}

            <div class="navbar-user">
              <div class="user-dropdown">
                <button class="user-dropdown-toggle" onclick="toggleUserMenu()">
                  {{ user.get_short_name }} ‚ñæ
                </button>
                <div class="user-dropdown-menu" id="userMenu">
                  <a href="{% url 'accounts:profile' %}" class="dropdown-item">Profile</a>
                  <a href="{% url 'families:family_list' %}" class="dropdown-item">My Families</a>
                  <a href="{% url 'trips:trip_list' %}" class="dropdown-item">All Trips</a>
                  <div class="dropdown-divider"></div>
                  <a href="{% url 'accounts:logout' %}" class="dropdown-item">Logout</a>
                </div>
              </div>
            </div>
          {% else %}
            <a href="{% url 'accounts:login' %}" class="btn btn-sm btn-primary">Login</a>
            <a href="{% url 'accounts:register' %}" class="btn btn-sm btn-outline">Sign Up</a>
          {% endif %}
        </div>        </div>
    </nav>

    <!-- Messages -->
    {% if messages %}
      <div class="messages-container">
        <div class="container">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- Breadcrumbs -->
    {% block breadcrumbs %}{% endblock %}

    <!-- Main Content -->
    <main class="main-content">
      {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="footer">
      <div class="container">
        <p class="footer-text">&copy; 2025 HaleWay. Built for family.</p>
      </div>
    </footer>

    <!-- Trip Switcher Modal -->
    {% if user.is_authenticated %}
      <div id="tripSwitcherModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
          <div class="modal-header">
            <h3>Switch Trip</h3>
            <button type="button" class="modal-close" onclick="closeTripSwitcher()">&times;</button>
          </div>
          <div class="modal-body" id="tripSwitcherBody">
            <p>Loading trips...</p>
          </div>
        </div>
      </div>
    {% endif %}

    <!-- Page-specific JavaScript -->
    {% block extra_js %}{% endblock %}

    <!-- Navigation Scripts -->
    <script>
      function toggleUserMenu() {
        const menu = document.getElementById('userMenu');
        menu.classList.toggle('show');
        // Close other menus
        const tripMenu = document.getElementById('tripMenu');
        const tripsMenu = document.getElementById('tripsMenu');
        if (tripMenu) tripMenu.classList.remove('show');
        if (tripsMenu) tripsMenu.classList.remove('show');
      }

      function toggleTripsMenu(event) {
        event.stopPropagation();
        const menu = document.getElementById('tripsMenu');
        menu.classList.toggle('show');
        // Close other menus
        const userMenu = document.getElementById('userMenu');
        const tripMenu = document.getElementById('tripMenu');
        if (userMenu) userMenu.classList.remove('show');
        if (tripMenu) tripMenu.classList.remove('show');
      }

      function toggleTripMenu(event) {
        event.stopPropagation();
        const menu = document.getElementById('tripMenu');
        menu.classList.toggle('show');
        // Close other menus
        const userMenu = document.getElementById('userMenu');
        const tripsMenu = document.getElementById('tripsMenu');
        if (userMenu) userMenu.classList.remove('show');
        if (tripsMenu) tripsMenu.classList.remove('show');
      }

      // Close dropdowns when clicking outside
      window.addEventListener('click', function(e) {
        if (!e.target.matches('.user-dropdown-toggle') && !e.target.matches('.nav-dropdown-toggle')) {
          const userMenu = document.getElementById('userMenu');
          const tripMenu = document.getElementById('tripMenu');
          const tripsMenu = document.getElementById('tripsMenu');
          if (userMenu && userMenu.classList.contains('show')) {
            userMenu.classList.remove('show');
          }
          if (tripMenu && tripMenu.classList.contains('show')) {
            tripMenu.classList.remove('show');
          }
          if (tripsMenu && tripsMenu.classList.contains('show')) {
            tripsMenu.classList.remove('show');
          }
        }
      });

      // Trip Switcher Modal
      function openTripSwitcher(event) {
        event.preventDefault();
        const modal = document.getElementById('tripSwitcherModal');
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';

        // Load trips
        fetch('{% url "core:get_user_trips" %}')
          .then(response => response.json())
          .then(data => {
            const body = document.getElementById('tripSwitcherBody');
            if (data.trips.length === 0) {
              body.innerHTML = '<p class="text-muted">You have no trips yet. <a href="{% url "trips:trip_list" %}">Go to trips page to create one!</a></p>';
              return;
            }

            let html = '<div class="trip-list">';
            data.trips.forEach(trip => {
              const isCurrent = trip.is_current ? ' (current)' : '';
              html += `
                <div class="trip-list-item ${trip.is_current ? 'current' : ''}">
                  <div class="trip-info">
                    <h4>${trip.name}${isCurrent}</h4>
                    <p class="trip-dates">${trip.destination} ‚Ä¢ ${trip.date_range}</p>
                  </div>
                  ${!trip.is_current ? `<button class="btn btn-sm btn-primary" onclick="switchToTrip('${trip.id}')">Switch</button>` : ''}
                </div>
              `;
            });
            html += '</div>';
            body.innerHTML = html;
          })
          .catch(error => {
            console.error('Error loading trips:', error);
            document.getElementById('tripSwitcherBody').innerHTML = '<p class="text-danger">Error loading trips. Please try again.</p>';
          });
      }

      function closeTripSwitcher() {
        const modal = document.getElementById('tripSwitcherModal');
        modal.classList.remove('show');
        document.body.style.overflow = '';
      }

      function switchToTrip(tripId) {
        fetch('{% url "core:set_current_trip" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ trip_id: tripId })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              window.location.reload();
            } else {
              alert('Failed to switch trip: ' + data.error);
            }
          })
          .catch(error => {
            console.error('Error switching trip:', error);
            alert('Failed to switch trip. Please try again.');
          });
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }

      // Close modal on escape key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          const modal = document.getElementById('tripSwitcherModal');
          if (modal && modal.classList.contains('show')) {
            closeTripSwitcher();
          }
        }
      });

      // Close modal when clicking outside
      document.getElementById('tripSwitcherModal')?.addEventListener('click', function(e) {
        if (e.target === this) {
          closeTripSwitcher();
        }
      });
    </script>
  </body>
</html>
